{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Social App{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <div class="container">
        {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
        {% block content %}
        {% endblock %}
    </div>
    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Get the element with id="defaultOpen" and click on it
        document.addEventListener('DOMContentLoaded', (event) => {
            document.getElementById("defaultOpen").click();
        });

        // Lightbox functions (from home.html, moved here for global access)
        function openLightbox(imageUrl) {
            document.getElementById("myLightbox").classList.remove("hidden");
            document.getElementById("img01").src = imageUrl;
        }

        function closeLightbox() {
            document.getElementById("myLightbox").classList.add("hidden");
        }

        // User Profile Modal functions
        async function openConnectionProfile(userId) {
            const userProfileModal = document.getElementById('userProfileModal');
            const modalProfilePic = document.getElementById('modal-profile-pic');
            const modalDisplayName = document.getElementById('modal-display-name');
            const modalBio = document.getElementById('modal-bio');
            const modalUserPosts = document.getElementById('modal-user-posts');

            // Clear previous content
            modalUserPosts.innerHTML = '';
            modalProfilePic.src = '';
            modalDisplayName.textContent = '';
            modalBio.textContent = '';

            try {
                const response = await fetch(`/api/users/${userId}/profile_and_posts/`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                const profile = data.profile;
                const posts = data.posts;

                modalProfilePic.src = profile.profile_picture_url || '/static/default_profile_pic.png';
                modalDisplayName.textContent = profile.display_name || 'N/A';
                modalBio.textContent = profile.bio || 'No bio available.';

                if (posts && posts.length > 0) {
                    const ul = document.createElement('ul');
                    posts.forEach(post => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <img src="${post.image_url}" alt="Post Image" class="post-image" onclick="openLightbox('${post.image_url}')">
                            <p>${post.caption}</p>
                            <small>Posted at: ${new Date(post.created_at).toLocaleString()}</small>
                        `;
                        ul.appendChild(li);
                    });
                    modalUserPosts.appendChild(ul);
                } else {
                    modalUserPosts.innerHTML = '<p>No posts found for this user.</p>';
                }

                userProfileModal.style.display = 'block';
            } catch (error) {
                console.error('Error fetching user profile and posts:', error);
                alert('Failed to load user profile. Please try again.');
            }
        }

        function closeUserProfileModal() {
            document.getElementById('userProfileModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const userProfileModal = document.getElementById('userProfileModal');
            const myLightbox = document.getElementById('myLightbox');
            if (event.target == userProfileModal) {
                userProfileModal.style.display = "none";
            }
            if (event.target == myLightbox) {
                myLightbox.classList.add("hidden");
            }
        }


    </script>
</body>
</html>
