{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
    <img src="/static/logo.png" alt="Logo" class="header-logo">
    <div class="home-profile-pic-container">
        <img src="{{ profile_picture_url|default:'/static/default_profile_pic.png' }}" alt="Profile Pic" class="home-profile-pic" onclick="openTab(event, 'ProfileContent')">
        {% if display_name %}
            <div class="display-name-text">{{ display_name }}</div>
        {% endif %}
    </div>

    <div class="tabs">
        <button class="create-post-button-tab" onclick="openTab(event, 'CreatePostContent')">
            &#x2795;
        </button>
        <button class="tablinks" onclick="openTab(event, 'ConnectionsPosts')" id="defaultOpen">Posts</button>
        <button class="tablinks" onclick="openTab(event, 'MyPosts')">My Posts</button>
        <button class="tablinks" onclick="openTab(event, 'Connections')">Connections</button>
    </div>

    <div id="ConnectionsPosts" class="tabcontent">

        {% if connections_posts %}
            <ul>
                {% for post in connections_posts %}
                    <li>
                        <div class="post-author-info">
                            <img src="{{ post.author_profile_picture_url|default:'/static/default_profile_pic.png' }}" alt="Profile Pic" class="post-author-pic">
                            <strong>{{ post.author_display_name|default:'Unknown User' }}</strong>
                        </div>
                        <img src="{{ post.image_url }}" alt="Post Image" class="post-image" onclick="openLightbox('{{ post.image_url }}')">
                        <p>{{ post.caption }}</p>
                        <small>Posted at: {{ post.created_at|date:"d/m/y H:i" }}</small>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No posts found from your connections.</p>
        {% endif %}
    </div>

    <div id="MyPosts" class="tabcontent">
        <div class="my-posts-header">
            {# Removed + button from here #}
        </div>
        {% if my_posts %}
            <ul>
                {% for post in my_posts %}
                    <li>
                        <div class="post-author-info">
                            <img src="{{ profile_picture_url|default:'/static/default_profile_pic.png' }}" alt="Profile Pic" class="post-author-pic">
                            <strong>{{ display_name|default:'Unknown User' }}</strong>
                        </div>
                        <img src="{{ post.image_url }}" alt="Post Image" class="post-image" onclick="openLightbox('{{ post.image_url }}')">
                        <p>{{ post.caption }}</p>
                        <small>Posted at: {{ post.created_at|date:"d/m/y H:i" }}</small>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No posts found.</p>
        {% endif %}
    </div>

    <div id="Connections" class="tabcontent">
        <h3>My Connections:</h3>
        {% if connections %}
            <div class="connections-grid">
                {% for connection in connections %}
                    <div class="connection-grid-item">
                        <img src="{{ connection.profile_picture_url|default:'/static/default_profile_pic.png' }}" alt="Profile Pic" class="connection-profile-pic">
                        <div class="connection-display-name">{{ connection.display_name|default:'N/A' }}</div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>No connections yet. <a href="{% url 'send_connection_request' %}">Send a connection request</a>.</p>
        {% endif %}

        <hr>

        <h3>Find a New Connection:</h3>
        <input type="text" id="userSearchInput" placeholder="Search users by display name...">
        <div id="searchResults" class="connections-grid">
            <!-- Search results will be displayed here -->
        </div>

        <hr>

        <h3>Pending Connection Requests:</h3>
        {% if pending_requests %}
            <div class="connections-grid">
                {% for request in pending_requests %}
                    <div class="connection-grid-item">
                        <img src="{{ request.from_user_profile_picture_url|default:'/static/default_profile_pic.png' }}" alt="Profile Pic" class="connection-profile-pic">
                        <div class="connection-display-name">{{ request.from_user_display_name|default:'N/A' }}</div>
                        <div class="connection-actions">
                            <strong>
                                <a href="#" onclick="document.getElementById('accept-form-{{ request.request_id }}').submit(); return false;" style="color: black; text-decoration: none;">Accept</a>
                                or
                                <a href="#" onclick="document.getElementById('deny-form-{{ request.request_id }}').submit(); return false;" style="color: black; text-decoration: none;">Deny</a>
                            </strong>
                        </div>
                        <form id="accept-form-{{ request.request_id }}" method="post" action="{% url 'accept_connection_request' %}" style="display:none;">
                            {% csrf_token %}
                            <input type="hidden" name="request_id" value="{{ request.request_id }}">
                        </form>
                        <form id="deny-form-{{ request.request_id }}" method="post" action="{% url 'deny_connection_request' %}" style="display:none;">
                            {% csrf_token %}
                            <input type="hidden" name="request_id" value="{{ request.request_id }}">
                        </form>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>No pending connection requests.</p>
        {% endif %}

        <hr>

        <h3>Sent Connection Requests:</h3>
        {% if sent_requests %}
            <div class="connections-grid">
                {% for request in sent_requests %}
                    <div class="connection-grid-item">
                        <img src="{{ request.to_user_profile_picture_url|default:'/static/default_profile_pic.png' }}" alt="Profile Pic" class="connection-profile-pic">
                        <div class="connection-display-name">{{ request.to_user_display_name|default:'N/A' }}<br>(Pending)</div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>No sent connection requests.</p>
        {% endif %}
    </div>

    {# Profile Content #}
    <div id="ProfileContent" class="tabcontent">
        <input type="checkbox" id="debug-info-toggle" class="hidden">
        <label for="debug-info-toggle" class="debug-info-label">Debug Information</label>
        <div class="debug-info-content">
            <p>Your User ID: {{ profile_data.user_id }}</p>
            <p class="jwt-token-text">Your JWT Token: <span class="jwt-token-value">{{ jwt_token }}</span></p>
        </div>

        <form method="post">
            {% csrf_token %}
            {{ profile_form.as_p }}
            <button type="submit" name="update_profile" style="background-color: black; color: white;">Update</button>
        </form>
    </div>

    {# Create Post Content #}
    <div id="CreatePostContent" class="tabcontent">
        <h2>Add a New Post</h2>
        <form id="add-post-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <!-- Tab navigation -->
            <div class="tabs">
                <button type="button" class="tablinks active" onclick="openCreatePostTab(event, 'Upload')">Upload</button>
                <button type="button" class="tablinks" onclick="openCreatePostTab(event, 'URL')">URL</button>
                                <button type="button" class="tablinks" onclick="openCreatePostTab(event, 'Camera')">Camera</button>
                <button type="button" class="tablinks" onclick="openCreatePostTab(event, 'Library')">Library</button>
            </div>

            <!-- Tab content -->
            <div id="Upload" class="tabcontent" style="display: block;">
                <input type="file" id="file-input" name="file_upload" accept="image/png, image/jpeg, image/gif, image/webp, image/heic">
                <p id="file-error" class="error-message"></p>
            </div>

            <div id="URL" class="tabcontent">
                <input type="text" id="url-input" name="image_url" placeholder="Enter image URL">
                <p id="url-error" class="error-message"></p>
            </div>

            <div id="Camera" class="tabcontent">
                <video id="camera-stream" width="320" height="240" autoplay></video>
                <button type="button" id="capture-btn">Capture</button>
                <canvas id="canvas" width="320" height="240"></canvas>
                <p id="camera-error" class="error-message"></p>
            </div>

            <div id="Library" class="tabcontent">
                <input type="file" id="library-input" name="library_upload" accept="image/*">
                <p id="library-error" class="error-message"></p>
            </div>

            <!-- Caption -->
            <div>
                <label for="caption-input">Caption:</label>
                <textarea id="caption-input" name="caption" maxlength="140"></textarea>
                <p id="char-counter">140 characters remaining</p>
                <p id="caption-error" class="error-message"></p>
            </div>

            <button type="submit" id="post-submit-btn">Post</button>
        </form>

        <script>
            let activeTab = 'Upload';
            const allowedExtensions = ['png', 'jpeg', 'jpg', 'gif', 'webp', 'heic'];
            let mediaStream = null;

            function openCreatePostTab(evt, tabName) {
                var i, tabcontent, tablinks;
                tabcontent = document.querySelectorAll('#CreatePostContent .tabcontent');
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }
                tablinks = document.querySelectorAll('#CreatePostContent .tablinks');
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].className = tablinks[i].className.replace(" active", "");
                }
                document.getElementById(tabName).style.display = "block";
                evt.currentTarget.className += " active";
                activeTab = tabName;
                clearErrors();

                if (tabName === 'Camera') {
                    startCamera();
                } else {
                    stopCamera();
                }
            }

            function clearErrors() {
                document.getElementById('file-error').innerText = '';
                document.getElementById('url-error').innerText = '';
                document.getElementById('camera-error').innerText = '';
                document.getElementById('library-error').innerText = '';
                document.getElementById('caption-error').innerText = '';
            }

            // Camera functionality
            const cameraStream = document.getElementById('camera-stream');
            const captureBtn = document.getElementById('capture-btn');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            let capturedImageBlob = null;

            async function startCamera() {
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    cameraStream.srcObject = mediaStream;
                    cameraStream.play();
                    document.getElementById('camera-error').innerText = '';
                } catch (err) {
                    document.getElementById('camera-error').innerText = 'Could not access camera. Please ensure permissions are granted.';
                    console.error("Error accessing camera: ", err);
                }
            }

            function stopCamera() {
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    cameraStream.srcObject = null;
                }
            }

            captureBtn.addEventListener('click', () => {
                context.drawImage(cameraStream, 0, 0, canvas.width, canvas.height);
                canvas.toBlob((blob) => {
                    capturedImageBlob = blob;
                    // Optionally display the captured image
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(blob);
                    img.width = 320;
                    img.height = 240;
                    document.getElementById('Camera').appendChild(img);
                }, 'image/png'); // You can change the image format here
            });

            // Library functionality
            const libraryInput = document.getElementById('library-input');
            libraryInput.addEventListener('change', (event) => {
                if (event.target.files.length > 0) {
                    const file = event.target.files[0];
                    const fileName = file.name;
                    const fileExtension = fileName.split('.').pop().toLowerCase();
                    if (!allowedExtensions.includes(fileExtension)) {
                        document.getElementById('library-error').innerText = 'Unsupported file type';
                        event.target.value = ''; // Clear the input
                        return;
                    }
                    capturedImageBlob = file;
                } else {
                    capturedImageBlob = null;
                }
            });

            // Character counter for caption
            const captionInput = document.getElementById('caption-input');
            const charCounter = document.getElementById('char-counter');
            captionInput.addEventListener('input', () => {
                const remaining = 140 - captionInput.value.length;
                charCounter.innerText = `${remaining} characters remaining`;
                if (remaining < 0) {
                    charCounter.style.color = 'red';
                } else {
                    charCounter.style.color = 'black';
                }
            });

            // Form submission handling
            document.getElementById('add-post-form').addEventListener('submit', async (event) => {
                event.preventDefault();
                clearErrors();

                const caption = captionInput.value;
                if (caption.length === 0) {
                    document.getElementById('caption-error').innerText = 'Caption is required';
                    return;
                }
                if (caption.length > 140) {
                    document.getElementById('caption-error').innerText = 'Caption too long (max 140 characters)';
                    return;
                }

                let imageUrl = '';
                let fileToUpload = null;

                if (activeTab === 'Upload') {
                    const fileInput = document.getElementById('file-input');
                    if (fileInput.files.length > 0) {
                        fileToUpload = fileInput.files[0];
                        const fileName = fileToUpload.name;
                        const fileExtension = fileName.split('.').pop().toLowerCase();
                        if (!allowedExtensions.includes(fileExtension)) {
                            document.getElementById('file-error').innerText = 'Unsupported file type';
                            return;
                        }
                    } else {
                        document.getElementById('file-error').innerText = 'Image upload is required';
                        return;
                    }
                } else if (activeTab === 'URL') {
                    const urlInput = document.getElementById('url-input');
                    imageUrl = urlInput.value;
                    if (imageUrl.length === 0) {
                        document.getElementById('url-error').innerText = 'Image URL is required';
                        return;
                    }
                    try {
                        new URL(imageUrl);
                        const urlExtension = imageUrl.split('.').pop().toLowerCase();
                        if (!allowedExtensions.includes(urlExtension)) {
                            document.getElementById('url-error').innerText = 'Unsupported image URL type';
                            return;
                        }
                    } catch (_) {
                        document.getElementById('url-error').innerText = 'Invalid URL';
                        return;
                    }
                } else if (activeTab === 'Camera' || activeTab === 'Library') {
                    if (!capturedImageBlob) {
                        document.getElementById('camera-error').innerText = 'Please capture or select an image.';
                        return;
                    }
                    fileToUpload = capturedImageBlob;
                }

                let finalImageUrl = imageUrl;

                if (fileToUpload) {
                    const formData = new FormData();
                    formData.append('file', fileToUpload);

                    const uploadResponse = await fetch('/api/posts/upload-image', {
                        method: 'POST',
                        headers: {
                            'x-access-token': '{{ request.session.jwt_token }}' // Assuming JWT token is available in session
                        },
                        body: formData,
                    });

                    if (uploadResponse.ok) {
                        const data = await uploadResponse.json();
                        finalImageUrl = data.filename; // Assuming backend returns filename
                    } else {
                        document.getElementById('file-error').innerText = 'Image upload failed';
                        return;
                    }
                }

                const postData = {
                    image_url: finalImageUrl,
                    caption: caption,
                };

                const postResponse = await fetch('/api/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-access-token': '{{ request.session.jwt_token }}' // Assuming JWT token is available in session
                    },
                    body: JSON.stringify(postData),
                });

                if (postResponse.ok) {
                    window.location.href = '/users/{{ request.session.user_id }}/posts'; // Redirect to user's posts
                } else {
                    const errorData = await postResponse.json();
                    document.getElementById('caption-error').innerText = errorData.message || 'Failed to create post';
                }
            });

            // Initial tab display
            document.addEventListener('DOMContentLoaded', () => {
                document.querySelector('.tablinks').click();
            });
        </script>
    </div>

    <p><a href="{% url 'logout' %}">Logout</a></p>

    {# Lightbox Modal #}
    <div id="myLightbox" class="lightbox hidden">
        <span class="close-button" onclick="closeLightbox()">&times;</span>
        <img class="lightbox-content" id="img01">
    </div>

    {# User Profile Modal #}
    <div id="userProfileModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeUserProfileModal()">&times;</span>
            <div id="modal-profile-pic-container" style="text-align: center; margin-bottom: 15px;">
                <img id="modal-profile-pic" src="" alt="Profile Picture" class="home-profile-pic" style="width: 100px; height: 100px;">
            </div>
            <h2 id="modal-display-name" style="text-align: center; margin-bottom: 10px;"></h2>
            <p id="modal-bio" style="text-align: center; margin-bottom: 20px;"></p>

            <h3>Posts:</h3>
            <div id="modal-user-posts">
                <!-- User posts will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userSearchInput = document.getElementById('userSearchInput');
            const searchResultsDiv = document.getElementById('searchResults');

            userSearchInput.addEventListener('input', function() {
                const query = this.value;
                if (query.length > 2) { // Only search if query is at least 3 characters long
                    fetch(`/api/users/search/?query=${query}`, {
                        headers: {
                            'x-access-token': '{{ jwt_token }}'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            searchResultsDiv.innerHTML = ''; // Clear previous results
                            const users = data.users;
                            if (users && users.length > 0) {
                                for (let i = 0; i < users.length; i++) {
                                    const user = users[i];
                                    const userDiv = document.createElement('div');
                                    userDiv.className = 'connection-grid-item';

                                    let buttonHtml = '';
                                    if (!user.is_connection) {
                                        buttonHtml = `<button class="send-request-button" data-user-id="${user.user_id}">+</button>`;
                                    }

                                    userDiv.innerHTML = `
                                        <img src="${user.profile_picture_url || '/static/default_profile_pic.png'}" alt="Profile Pic" class="connection-profile-pic">
                                        <div class="connection-display-name">${user.display_name || 'N/A'}</div>
                                        ${buttonHtml}
                                    `;
                                    searchResultsDiv.appendChild(userDiv);
                                }
                            } else {
                                searchResultsDiv.innerHTML = '<p>No users found.</p>';
                            }
                        })
                        .catch(error => {
                            console.error('Error searching users:', error);
                            searchResultsDiv.innerHTML = '<p>Error searching users.</p>';
                        });
                } else {
                    searchResultsDiv.innerHTML = ''; // Clear results if query is too short
                }
            });

            // Add event listener for the send request buttons
            searchResultsDiv.addEventListener('click', function(event) {
                if (event.target.classList.contains('send-request-button')) {
                    const toUserId = event.target.dataset.userId;
                    sendConnectionRequest(toUserId, event.target);
                }
            });
        });

        function sendConnectionRequest(toUserId, button) {
            fetch('/api/connections/request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'x-access-token': '{{ jwt_token }}'
                },
                body: JSON.stringify({ to_user_id: toUserId })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Network response was not ok.');
                    });
                }
            })
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    if (data.message === 'Connection request sent successfully') {
                        button.style.display = 'none';
                        location.reload();
                    }
                } else {
                    alert('An unknown error occurred.');
                }
            })
            .catch(error => {
                console.error('Error sending connection request:', error);
                alert(error.message);
            });
        }

        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

{% endblock %}
